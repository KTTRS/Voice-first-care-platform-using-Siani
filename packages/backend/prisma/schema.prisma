// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  PATIENT
  CAREGIVER
}

enum SignalType {
  VITAL_SIGN
  SYMPTOM
  MEDICATION
  MOOD
  ACTIVITY
}

enum SignalSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReferralStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(PATIENT)
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientsAsDoctor  Patient[]      @relation("DoctorPatients")
  patientsAsNurse   Patient[]      @relation("NursePatients")
  patientProfile    Patient?       @relation("UserPatient")
  signals           Signal[]
  referralsCreated  Referral[]     @relation("CreatedReferrals")
  referralsReceived Referral[]     @relation("ReceivedReferrals")
  memories          Memory[]
  memoryMoments     MemoryMoment[]
  goals             Goal[]
  dailyActions      DailyAction[]
  referralLoops     ReferralLoop[]
  signalEvents      SignalEvent[]
  feedEvents        FeedEvent[]

  @@map("users")
}

model Patient {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserPatient", fields: [userId], references: [id], onDelete: Cascade)

  dateOfBirth        DateTime
  medicalHistory     String?
  allergies          String?
  currentMedications String?
  emergencyContact   String?

  assignedDoctorId String?
  assignedDoctor   User?   @relation("DoctorPatients", fields: [assignedDoctorId], references: [id])

  assignedNurseId String?
  assignedNurse   User?   @relation("NursePatients", fields: [assignedNurseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  signals   Signal[]
  referrals Referral[]

  @@map("patients")
}

model Signal {
  id       String         @id @default(uuid())
  type     SignalType
  severity SignalSeverity @default(LOW)
  value    String
  metadata Json?
  score    Float          @default(0)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  recordedById String
  recordedBy   User   @relation(fields: [recordedById], references: [id])

  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([patientId, timestamp])
  @@index([severity])
  @@map("signals")
}

model Referral {
  id       String         @id @default(uuid())
  status   ReferralStatus @default(PENDING)
  reason   String
  notes    String?
  priority Int            @default(1)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  fromUserId String
  fromUser   User   @relation("CreatedReferrals", fields: [fromUserId], references: [id])

  toUserId String
  toUser   User   @relation("ReceivedReferrals", fields: [toUserId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([patientId])
  @@index([status])
  @@map("referrals")
}

model Memory {
  id        String  @id @default(uuid())
  content   String
  embedding String? // JSON array of floats
  metadata  Json?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  conversationId String?
  importance     Float   @default(0.5)

  createdAt  DateTime @default(now())
  accessedAt DateTime @default(now())

  @@index([userId, conversationId])
  @@index([importance])
  @@map("memories")
}

model MemoryMoment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  emotion   String
  tone      String
  vectorId  String
  createdAt DateTime @default(now())

  @@map("memory_moments")
}

model Goal {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  points    Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  dailyActions DailyAction[]
  feedEvents   FeedEvent[]

  @@map("goals")
}

model DailyAction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goalId    String?
  goal      Goal?    @relation(fields: [goalId], references: [id])
  content   String
  points    Int
  completed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("daily_actions")
}

model ReferralLoop {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource  String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("referral_loops")
}

model SignalEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  delta     Float
  createdAt DateTime @default(now())

  @@map("signal_events")
}

model FeedEvent {
  id        String   @id @default(cuid())
  type      String   // GOAL_CREATED, GOAL_COMPLETED, DAILY_ACTION_COMPLETED, etc.
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goalId    String?  // Optional reference for goal-related events
  goal      Goal?    @relation(fields: [goalId], references: [id])
  message   String   // Human-readable text for frontend
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("feed_events")
}
