generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model daily_actions {
  id        String   @id
  userId    String
  goalId    String?
  content   String
  points    Int
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  goals     goals?   @relation(fields: [goalId], references: [id])
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model feed_events {
  id        String   @id
  type      String
  userId    String
  goalId    String?
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime
  goals     goals?   @relation(fields: [goalId], references: [id])
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([type])
  @@index([userId])
}

model goals {
  id            String          @id
  userId        String
  title         String
  points        Int
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  daily_actions daily_actions[]
  feed_events   feed_events[]
  users         users           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model memories {
  id             String   @id
  content        String
  embedding      String?
  metadata       Json?
  userId         String
  conversationId String?
  importance     Float    @default(0.5)
  createdAt      DateTime @default(now())
  accessedAt     DateTime @default(now())
  users          users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([importance])
  @@index([userId, conversationId])
}

model memory_moments {
  id        String   @id
  userId    String
  content   String
  emotion   String
  tone      String
  vectorId  String
  source    String?  @default("text")
  metadata  Json?
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model patients {
  id                                     String      @id
  userId                                 String      @unique
  dateOfBirth                            DateTime
  medicalHistory                         String?
  allergies                              String?
  currentMedications                     String?
  emergencyContact                       String?
  assignedDoctorId                       String?
  assignedNurseId                        String?
  createdAt                              DateTime    @default(now())
  updatedAt                              DateTime
  users_patients_assignedDoctorIdTousers users?      @relation("patients_assignedDoctorIdTousers", fields: [assignedDoctorId], references: [id])
  users_patients_assignedNurseIdTousers  users?      @relation("patients_assignedNurseIdTousers", fields: [assignedNurseId], references: [id])
  users_patients_userIdTousers           users       @relation("patients_userIdTousers", fields: [userId], references: [id], onDelete: Cascade)
  referrals                              referrals[]
  signals                                signals[]
}

model referral_loops {
  id        String   @id
  userId    String
  resource  String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model referrals {
  id                                String         @id
  status                            ReferralStatus @default(PENDING)
  reason                            String
  notes                             String?
  priority                          Int            @default(1)
  patientId                         String
  fromUserId                        String
  toUserId                          String
  createdAt                         DateTime       @default(now())
  updatedAt                         DateTime
  completedAt                       DateTime?
  users_referrals_fromUserIdTousers users          @relation("referrals_fromUserIdTousers", fields: [fromUserId], references: [id])
  patients                          patients       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  users_referrals_toUserIdTousers   users          @relation("referrals_toUserIdTousers", fields: [toUserId], references: [id])

  @@index([patientId])
  @@index([status])
}

model resource_engagements {
  id               String    @id
  userId           String
  resourceId       String?
  resourceName     String    @default("")
  resourceType     String    @default("")
  needType         String
  status           String
  confidence       Float?
  detectionContext String?
  detectedAt       DateTime  @default(now())
  offeredAt        DateTime?
  acceptedAt       DateTime?
  declinedAt       DateTime?
  completedAt      DateTime?
  failedAt         DateTime?
  followedUpAt     DateTime?
  closedAt         DateTime?
  lastFollowUpAt   DateTime?
  successRating    Int?
  impactNotes      String?
  offeredBy        String?
  declineReason    String?
  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  users            users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([detectedAt])
  @@index([needType])
  @@index([status])
  @@index([userId])
}

model signal_events {
  id        String   @id
  userId    String
  type      String
  delta     Float
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model signal_scores {
  id                  String    @id
  userId              String
  medicationAdherence Float     @default(0)
  mentalHealthRisk    Float     @default(0)
  socialIsolation     Float     @default(0)
  careCoordination    Float     @default(0)
  systemTrust         Float     @default(0)
  overallRisk         Float     @default(0)
  trendMedication     Float     @default(0)
  trendMentalHealth   Float     @default(0)
  trendSocial         Float     @default(0)
  totalMoments        Int       @default(0)
  totalGoalsCompleted Int       @default(0)
  streakDays          Int       @default(0)
  lastActivityAt      DateTime?
  detectedNeeds       String[]  @default([])
  sdohRisk            Float     @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  users               users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([overallRisk])
  @@index([userId])
}

model signals {
  id           String         @id
  type         SignalType
  severity     SignalSeverity @default(LOW)
  value        String
  metadata     Json?
  score        Float          @default(0)
  patientId    String
  recordedById String
  timestamp    DateTime       @default(now())
  createdAt    DateTime       @default(now())
  patients     patients       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  users        users          @relation(fields: [recordedById], references: [id])

  @@index([patientId, timestamp])
  @@index([severity])
}

model users {
  id                                        String                 @id
  email                                     String                 @unique
  password                                  String
  firstName                                 String
  lastName                                  String
  role                                      UserRole               @default(PATIENT)
  phone                                     String?
  createdAt                                 DateTime               @default(now())
  updatedAt                                 DateTime
  daily_actions                             daily_actions[]
  feed_events                               feed_events[]
  goals                                     goals[]
  memories                                  memories[]
  memory_moments                            memory_moments[]
  patients_patients_assignedDoctorIdTousers patients[]             @relation("patients_assignedDoctorIdTousers")
  patients_patients_assignedNurseIdTousers  patients[]             @relation("patients_assignedNurseIdTousers")
  patients_patients_userIdTousers           patients?              @relation("patients_userIdTousers")
  referral_loops                            referral_loops[]
  referrals_referrals_fromUserIdTousers     referrals[]            @relation("referrals_fromUserIdTousers")
  referrals_referrals_toUserIdTousers       referrals[]            @relation("referrals_toUserIdTousers")
  resource_engagements                      resource_engagements[]
  signal_events                             signal_events[]
  signal_scores                             signal_scores[]
  signals                                   signals[]
}

enum ReferralStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum SignalSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SignalType {
  VITAL_SIGN
  SYMPTOM
  MEDICATION
  MOOD
  ACTIVITY
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  PATIENT
  CAREGIVER
}
