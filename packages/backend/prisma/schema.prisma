// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  PATIENT
  CAREGIVER
  CHW // Community Health Worker
  PAYER // Insurance/payer organization
}

enum SignalType {
  VITAL_SIGN
  SYMPTOM
  MEDICATION
  MOOD
  ACTIVITY
}

enum SignalSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReferralStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED
}

// Conversation system enums
enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Emotion states mapped from classifier (Calm/Guarded/Lit)
enum EmotionState {
  CALM
  GUARDED
  LIT
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(PATIENT)
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientsAsDoctor  Patient[]      @relation("DoctorPatients")
  patientsAsNurse   Patient[]      @relation("NursePatients")
  patientProfile    Patient?       @relation("UserPatient")
  signals           Signal[]
  referralsCreated  Referral[]     @relation("CreatedReferrals")
  referralsReceived Referral[]     @relation("ReceivedReferrals")
  memories          Memory[]
  memoryMoments     MemoryMoment[]
  goals             Goal[]
  dailyActions      DailyAction[]
  referralLoops     ReferralLoop[]
  signalEvents      SignalEvent[]
  feedEvents        FeedEvent[]
  signalScores      SignalScore[]
  resourceEngagements ResourceEngagement[]
  relationalMemories RelationalMemory[]
  relationalContext  RelationalContext?
  // Backrelation for event store (actor)
  events             Event[]
  // Backrelation for conversations
  conversations      Conversation[]

  @@map("users")
}

model Patient {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserPatient", fields: [userId], references: [id], onDelete: Cascade)

  dateOfBirth        DateTime
  medicalHistory     String?
  allergies          String?
  currentMedications String?
  emergencyContact   String?

  assignedDoctorId String?
  assignedDoctor   User?   @relation("DoctorPatients", fields: [assignedDoctorId], references: [id])

  assignedNurseId String?
  assignedNurse   User?   @relation("NursePatients", fields: [assignedNurseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  signals   Signal[]
  referrals Referral[]

  @@map("patients")
}

model Signal {
  id       String         @id @default(uuid())
  type     SignalType
  severity SignalSeverity @default(LOW)
  value    String
  metadata Json?
  score    Float          @default(0)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  recordedById String
  recordedBy   User   @relation(fields: [recordedById], references: [id])

  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([patientId, timestamp])
  @@index([severity])
  @@map("signals")
}

model Referral {
  id       String         @id @default(uuid())
  status   ReferralStatus @default(PENDING)
  reason   String
  notes    String?
  priority Int            @default(1)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  fromUserId String
  fromUser   User   @relation("CreatedReferrals", fields: [fromUserId], references: [id])

  toUserId String
  toUser   User   @relation("ReceivedReferrals", fields: [toUserId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([patientId])
  @@index([status])
  @@map("referrals")
}

model Memory {
  id        String  @id @default(uuid())
  content   String
  embedding String? // JSON array of floats
  metadata  Json?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  conversationId String?
  importance     Float   @default(0.5)

  createdAt  DateTime @default(now())
  accessedAt DateTime @default(now())

  @@index([userId, conversationId])
  @@index([importance])
  @@map("memories")
}

model MemoryMoment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  emotion   String
  tone      String
  vectorId  String
  source    String?  @default("text") // text | voice | chat
  metadata  Json?    // Store audioFile, sdohFlags, etc.
  createdAt DateTime @default(now())

  @@map("memory_moments")
}

model Goal {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  points    Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  dailyActions DailyAction[]
  feedEvents   FeedEvent[]

  @@map("goals")
}

model DailyAction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goalId    String?
  goal      Goal?    @relation(fields: [goalId], references: [id])
  content   String
  points    Int
  completed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("daily_actions")
}

model ReferralLoop {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource  String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("referral_loops")
}

model SignalEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  delta     Float
  createdAt DateTime @default(now())

  @@map("signal_events")
}

model FeedEvent {
  id        String   @id @default(cuid())
  type      String   // GOAL_CREATED, GOAL_COMPLETED, DAILY_ACTION_COMPLETED, etc.
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goalId    String?  // Optional reference for goal-related events
  goal      Goal?    @relation(fields: [goalId], references: [id])
  message   String   // Human-readable text for frontend
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("feed_events")
}

model SignalScore {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Category Scores (0-10 scale, higher = more risk/concern)
  medicationAdherence Float @default(0)
  mentalHealthRisk    Float @default(0)
  socialIsolation     Float @default(0)
  careCoordination    Float @default(0)
  systemTrust         Float @default(0)

  // Overall composite score
  overallRisk Float @default(0)

  // Momentum indicators (-1 to 1: negative to positive)
  trendMedication  Float @default(0)
  trendMentalHealth Float @default(0)
  trendSocial      Float @default(0)

  // Contextual metadata
  totalMoments       Int      @default(0)
  totalGoalsCompleted Int     @default(0)
  streakDays         Int      @default(0)
  lastActivityAt     DateTime?

  // SDOH (Social Determinants of Health) detected needs
  detectedNeeds      String[] @default([])
  sdohRisk           Float    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([overallRisk])
  @@index([createdAt])
  @@map("signal_scores")
}

model ResourceEngagement {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Resource details
  resourceId    String?  // Optional reference to resource catalog
  resourceName  String   @default("") // e.g., "Food bank referral", "Housing assistance"
  resourceType  String   @default("") // e.g., "food", "housing", "transportation"
  
  // SDOH need this addresses
  needType   String   // e.g., "FOOD_INSECURITY", "HOUSING", "TRANSPORTATION"
  
  // Lifecycle tracking
  status     String   // "DETECTED" | "OFFERED" | "ACCEPTED" | "DECLINED" | "COMPLETED" | "FAILED" | "ABANDONED" | "ESCALATED"
  
  // Detection metadata
  confidence         Float?   // 0-1 confidence score from NLP
  detectionContext   String?  // Excerpt from conversation that triggered detection
  
  // Timestamps
  detectedAt   DateTime  @default(now())
  offeredAt    DateTime?
  acceptedAt   DateTime?
  declinedAt   DateTime?
  completedAt  DateTime?
  failedAt     DateTime?
  followedUpAt DateTime?
  closedAt     DateTime?
  lastFollowUpAt DateTime?
  
  // Outcome tracking
  successRating Int?     // 1-5 scale
  impactNotes   String?  // Free text about impact
  
  // Additional metadata
  offeredBy     String?  // System, provider, etc.
  declineReason String?  // If user declined
  metadata      Json     @default("{}")  // Flexible storage for triggers, followUpCount, etc.
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([needType])
  @@index([createdAt])
  @@index([detectedAt])
  @@map("resource_engagements")
}

model RelationalMemory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Content and context
  content   String   // The conversation content
  emotionVector String // JSON: [calm, guarded, lit] scores
  topics    String   // JSON: array of topic strings
  
  // Vector embedding for similarity search
  embedding String   // JSON: conversation embedding vector
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@map("relational_memories")
}

model RelationalContext {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Aggregated relational metrics
  topics    String   // JSON: array of recurring topics
  emotionVectorMean String // JSON: average emotional state
  
  // Trust and continuity scores (0-1)
  trustIndex      Float @default(0.5) // Frequency of emotionally open moments
  resonanceIndex  Float @default(0.5) // Emotional convergence with Siani
  continuityScore Float @default(0.5) // Emotional/topical overlap between sessions
  
  lastUpdate DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@map("relational_contexts")
}

model AuditLog {
  id        String   @id @default(cuid())
  
  // User and action details
  userId    String?  // Nullable for failed login attempts (user may not exist)
  action    String   // e.g., "LOGIN", "LOGOUT", "REGISTER", "SCOPE_CHECK", "TOKEN_REFRESH"
  resource  String?  // Resource being accessed (e.g., "/api/signals", "patient:read")
  
  // Result
  success   Boolean  @default(true)
  errorMessage String? // Error details for failed actions
  
  // Request metadata
  ipAddress String?
  userAgent String?
  
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([success])
  @@map("audit_logs")
}

// Immutable event store for foundational event-sourcing bridge
// Captures all domain events (check_in, referral_initiated, signal_scored, memory_created, etc.)
// Append-only: never update, only create. Use timestamp ordering for reconstruction.
model Event {
  id          String   @id @default(cuid())
  type        String   // e.g., CHECK_IN, REFERRAL_INITIATED, SIGNAL_SCORED
  actorUserId String?  // user initiating (nullable for system events)
  actor       User?    @relation(fields: [actorUserId], references: [id])
  entityType  String?  // e.g., "Referral", "Signal", "MemoryMoment"
  entityId    String?  // ID of the entity affected
  // Arbitrary payload stored as JSON for extensibility (must be redacted before insert)
  payload     Json?
  // Compliance & classification tags (HEDIS, STAR, CMS, SDOH, PRIVACY)
  tags        String[] @default([])
  // Correlation id for grouping events in a single logical transaction/session
  correlationId String? @default("")
  // Trace id for distributed tracing (future use)
  traceId       String? @default("")
  // Version for evolution of event structure
  schemaVersion Int      @default(1)
  // Immutability timestamp
  occurredAt    DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([type])
  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([occurredAt])
  @@map("events")
}

// High-level conversation session anchored to a single user.
// Each Conversation contains an ordered list of Message objects.
model Conversation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("conversations")
}

// Atomic message within a conversation: user input or assistant response.
// Stores text, optional emotion classification, and optional synthesized audio URL.
model Message {
  id             String        @id @default(cuid())
  conversationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           MessageRole
  text           String
  emotion        EmotionState?
  audioUrl       String?
  occurredAt     DateTime      @default(now()) // When the utterance happened
  createdAt      DateTime      @default(now())

  @@index([conversationId, occurredAt])
  @@map("messages")
}
